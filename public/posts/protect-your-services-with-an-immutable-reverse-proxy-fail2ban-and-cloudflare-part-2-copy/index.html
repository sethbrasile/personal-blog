<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>Protect Your Services with an Immutable Reverse Proxy, Fail2Ban, and Cloudflare (Part 2) | Seth Brasile</title>
<meta name="keywords" content="coreos, nginx, containers, immutable infrastructure, homelab, security, cloudflare">
<meta name="description" content="If you missed part 1, I highly recommend reading through it first to understand the concepts and theory behind the tools we&rsquo;ll be using. You can jump back to part 1 here.
Step-by-Step Guide Prerequisites Free Cloudflare account Public IP address Domain name Hopefully from Cloudflare.. It will make your life easier but it&rsquo;s not necessary, you can use any domain registrar as long as you change your nameservers to Cloudflare.">
<meta name="author" content="Seth Brasile">
<link rel="canonical" href="http://localhost:1313/posts/protect-your-services-with-an-immutable-reverse-proxy-fail2ban-and-cloudflare-part-2-copy/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css" integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z&#43;V9&#43;cO1A=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/protect-your-services-with-an-immutable-reverse-proxy-fail2ban-and-cloudflare-part-2-copy/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Seth Brasile (Alt + H)">Seth Brasile</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/posts/" title="posts">
                    <span>posts</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/categories/" title="categories">
                    <span>categories</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="tags">
                    <span>tags</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/about/" title="about">
                    <span>about</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/contact/" title="contact">
                    <span>contact</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Protect Your Services with an Immutable Reverse Proxy, Fail2Ban, and Cloudflare (Part 2)
      <span class="entry-hint" title="Draft">
        <svg xmlns="http://www.w3.org/2000/svg" height="35" viewBox="0 -960 960 960" fill="currentColor">
          <path
            d="M160-410v-60h300v60H160Zm0-165v-60h470v60H160Zm0-165v-60h470v60H160Zm360 580v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q9 9 13 20t4 22q0 11-4.5 22.5T862.09-380L643-160H520Zm300-263-37-37 37 37ZM580-220h38l121-122-18-19-19-18-122 121v38Zm141-141-19-18 37 37-18-19Z" />
        </svg>
      </span>
    </h1>
    <div class="post-meta"><span title='2024-04-22 11:38:01 -0500 CDT'>April 22, 2024</span>&nbsp;·&nbsp;Seth Brasile

</div>
  </header> 
  <div class="post-content"><blockquote>
<p><strong>If you missed part 1, I highly recommend reading through it first to understand the concepts and theory behind the tools we&rsquo;ll be using. You can <a href="/posts/protect-your-services-with-an-immutable-reverse-proxy-fail2ban-and-cloudflare-part-1/">jump back to part 1 here.</a></strong></p>
</blockquote>
<hr>
<h1 id="step-by-step-guide">Step-by-Step Guide<a hidden class="anchor" aria-hidden="true" href="#step-by-step-guide">#</a></h1>
<h2 id="prerequisites">Prerequisites<a hidden class="anchor" aria-hidden="true" href="#prerequisites">#</a></h2>
<ul>
<li>Free Cloudflare account</li>
<li>Public IP address</li>
<li>Domain name
<ul>
<li>Hopefully from Cloudflare.. It <em>will</em> make your life easier but it&rsquo;s not necessary, you can use any domain registrar as long as you change your nameservers to Cloudflare.</li>
</ul>
</li>
<li>Basic understanding of DNS</li>
<li>An enterprise grade firewall (or a home firewall that you&rsquo;ve configured to be enterprise grade)
<ul>
<li>We <em>need</em> the ability to define an isolated network or VLAN. This is crucial for security. If you&rsquo;re using a consumer-grade router, you&rsquo;re going to have a bad time. You <em>can</em> use a consumer-grade router, but you&rsquo;re going to have to install Tomato/OpenWrt/DD-WRT on it, OR you&rsquo;re going to have to stitch multiple routers together, and you&rsquo;re going to have to be very careful about what you&rsquo;re doing because it&rsquo;s nearly impossible to keep your LAN devices isolated from <em>probably nefarious</em> traffic.</li>
<li>In my opinion, <strong>the BEST way to do this</strong> is to repurpose an old computer as a pfSense/OPNsense firewall. This is a <strong>mostly-free</strong> option (assuming you have some old hardware or know someone who does). You likely only need to buy a dual or quad port pcie NIC, and you&rsquo;re good to go. This is the most secure option, and it&rsquo;s the option that I&rsquo;m going to be assuming you&rsquo;re using for the rest if this guide. If you&rsquo;re not, that&rsquo;s ok, all the concepts will apply nearly 1:1 to any enterprise grade firewall, you might just need to search for specifics on how to do things in your firewall&rsquo;s interface.</li>
</ul>
</li>
<li>Up-to-date software
<ul>
<li>Make sure that you&rsquo;re running the latest versions of your application web server and the application you&rsquo;re hosting. If what you&rsquo;re securing is a 10 year old version of WordPress, you&rsquo;re going to have a bad time either way.</li>
<li>If what you&rsquo;re hosting is a piece of legacy software that can&rsquo;t be updated or replaced, <em>you can</em> make it more secure with these techniques, but if there&rsquo;s a known vulnerability in the login page of the app that you&rsquo;re hosting, no amount of security is going to help you keep <em>that</em> piece of software secure* <em>(see note)</em>. You need to replace that software. Assuming your legacy app isn&rsquo;t running with root/admin privileges, you can still keep the other software on the server secure with these techniques.</li>
</ul>
</li>
</ul>
<p>*<em>it is technically possible to use a reverse proxy to inspect the contents of incoming traffic and block requests that match a known pattern, thereby writing a targeted protection for a given vulnerability, but this is a very advanced technique and it&rsquo;s not something that I&rsquo;m going to be discussing in this post. <a href="https://www.yourhowto.net/nginx-block-sql-injection-and-file-injection/">Here is a basic example of using this technique to block attempts at sql injection (written wayyyy back in 2013!).</a></em></p>
<h2 id="lets-do-it">Let&rsquo;s do it!<a hidden class="anchor" aria-hidden="true" href="#lets-do-it">#</a></h2>
<h2 id="conclusion">Conclusion<a hidden class="anchor" aria-hidden="true" href="#conclusion">#</a></h2>
<p>The integration of reverse proxies with Fail2Ban, all running in containers hosted on Fedora CoreOS, creates a formidable defense strategy for web services. This configuration leverages the strengths of each component—reverse proxies for traffic management and encryption, Fail2Ban for automated threat mitigation, and Fedora CoreOS containers for secure, scalable, and isolated environments. By adopting this approach, organizations can significantly enhance the security, reliability, and performance of their web services, staying one step ahead in the ongoing battle against cyber threats.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/coreos/">Coreos</a></li>
      <li><a href="http://localhost:1313/tags/nginx/">Nginx</a></li>
      <li><a href="http://localhost:1313/tags/containers/">Containers</a></li>
      <li><a href="http://localhost:1313/tags/immutable-infrastructure/">Immutable Infrastructure</a></li>
      <li><a href="http://localhost:1313/tags/homelab/">Homelab</a></li>
      <li><a href="http://localhost:1313/tags/security/">Security</a></li>
      <li><a href="http://localhost:1313/tags/cloudflare/">Cloudflare</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="http://localhost:1313/">Seth Brasile</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
